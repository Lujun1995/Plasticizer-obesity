---
title: "Plastic"
author: "Yun He, Jun Lu, Chu Yu, Chunxiao Zhai, Haoran Hu"
date: "11/21/2018"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(SASxport)
knitr::opts_chunk$set(
    fig.align = 'center',
    fig.width = 7,
    fig.asp = 0.6,
    out.width = "80%",
    message = F,
    warning = F
 )
theme_set(theme_bw() + theme(legend.position = "bottom"))


```

## Overview

## Read and clean the data
```{r}
phthte_file_name = tibble(file_name = list.files("./data/PHTHTE/"))

phthte =
  phthte_file_name %>% 
  mutate(map(str_c("./data/PHTHTE/", file_name), ~read.xport(.x))) %>% 
  unnest() 
    
demo_file_name = tibble(file_name_2 = list.files("./data/DEMO/"))

demo = 
    demo_file_name %>% 
    mutate(map(str_c("./data/DEMO/", file_name_2), ~read.xport(.x))) %>% 
    unnest()

phthe_demo = inner_join(demo, phthte, by = "SEQN") %>% 
    select(file_name, gender = RIAGENDR, age = RIDAGEYR, race = RIDRETH3, weight = WTMEC2YR, 
           income = INDFMPIR, URXCNP, URXCOP, URXECP, pregnancy_status = RIDEXPRG) %>% 
    mutate(phthe = log(URXCNP + URXCOP + URXECP),
           phthe_combin = ifelse(phthe > 3.73, 1 ,0),
           file_name = str_replace(file_name, "PHTHTE_", ""),
           file_name = str_replace(file_name, ".XPT", ""),
           race = plyr::mapvalues(race, c(1, 2, 3, 4, 6, 7), c("mexican_american", "other_hispanic", "non_hispanic_white", "non_hispanic_black", "non_hispanic_asian", "other_race")),
           pregnancy_status = plyr::mapvalues(pregnancy_status, c(1, 2, 3), c("yes", "no", "unknown"))) %>% 
  rename(year = file_name)
  
```

## Exploratory analysis

## Tendency analysis
```{r}
pd_tend = phthe_demo %>%
  group_by(year) %>%
  summarize(total = n(),
            proportion = length(which(phthe_combin == 1))/total)

pd_tend %>%
  ggplot(aes(x = year, y = proportion)) +
  geom_histogram(stat = "identity")

phthe_demo %>%
  ggplot(aes(x = year, y = phthe, fill = factor(year))) +
  geom_violin()
```

## Population compare

性别，种族，塑化剂随年龄变化